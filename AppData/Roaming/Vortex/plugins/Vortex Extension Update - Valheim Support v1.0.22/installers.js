"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.installFullPack = exports.installConfManager = exports.testConfManager = exports.testFullPack = exports.installCoreRemover = exports.testCoreRemover = exports.installInSlimModLoader = exports.testInSlimModLoader = exports.installVBuildMod = exports.testVBuild = exports.installBetterCont = exports.testBetterCont = void 0;
const bluebird_1 = __importDefault(require("bluebird"));
const path_1 = __importDefault(require("path"));
const vortex_api_1 = require("vortex-api");
const common_1 = require("./common");
const INVALID_DIRS = ['core', 'valheim_data'];
const INVALID_FILES = [common_1.DOORSTOPPER_HOOK].concat(common_1.IGNORABLE_FILES).map(file => file.toLowerCase());
const PACK_SEGMENTS = ['core_lib', 'unstripped_corlib'];
function indexOfPackSegment(segments) {
    const hasPackSegment = (seg) => PACK_SEGMENTS.includes(seg);
    const segment = segments.find(hasPackSegment);
    if (segment !== undefined) {
        return segments.indexOf(segment);
    }
    return -1;
}
function getPackType(seg) {
    switch (seg) {
        case 'core_lib':
            return 'core_lib';
        case 'unstripped_corlib':
            return 'unstripped_corlib';
        default:
            return 'none';
    }
}
function isInvalidSegment(filePathSegment, invalidCollection) {
    return invalidCollection.includes(filePathSegment);
}
function testBetterCont(files, gameId) {
    if (gameId !== common_1.GAME_ID) {
        return bluebird_1.default.resolve({ supported: false, requiredFiles: [] });
    }
    const supported = files.find(file => path_1.default.extname(file).toLowerCase() === common_1.BETTER_CONT_EXT) !== undefined;
    return bluebird_1.default.resolve({ supported, requiredFiles: [] });
}
exports.testBetterCont = testBetterCont;
function installBetterCont(files, destinationPath, gameId) {
    const filtered = files.filter(path_1.default.extname);
    const betterContFile = filtered.find(file => path_1.default.extname(file).toLowerCase() === common_1.BETTER_CONT_EXT);
    const idx = betterContFile.split(path_1.default.sep).indexOf(path_1.default.basename(betterContFile));
    const instructions = filtered.map(file => ({
        type: 'copy',
        source: file,
        destination: file.split(path_1.default.sep).slice(idx).join(path_1.default.sep),
    }));
    return bluebird_1.default.resolve({ instructions });
}
exports.installBetterCont = installBetterCont;
function testVBuild(files, gameId) {
    if (gameId !== common_1.GAME_ID) {
        return bluebird_1.default.resolve({ supported: false, requiredFiles: [] });
    }
    const supported = files.find(file => path_1.default.extname(file) === common_1.VBUILD_EXT) !== undefined;
    return bluebird_1.default.resolve({ supported, requiredFiles: [] });
}
exports.testVBuild = testVBuild;
function installVBuildMod(files, destinationPath, gameId) {
    const filtered = files.filter(file => path_1.default.extname(file) === common_1.VBUILD_EXT);
    const instructions = filtered.map(file => ({
        type: 'copy',
        source: file,
        destination: path_1.default.basename(file),
    }));
    return bluebird_1.default.resolve({ instructions });
}
exports.installVBuildMod = installVBuildMod;
function testInSlimModLoader(files, gameId) {
    if (gameId !== common_1.GAME_ID) {
        return bluebird_1.default.resolve({ supported: false, requiredFiles: [] });
    }
    const supported = files.find(file => path_1.default.basename(file) === common_1.INSLIMVML_IDENTIFIER) !== undefined;
    return bluebird_1.default.resolve({ supported, requiredFiles: [] });
}
exports.testInSlimModLoader = testInSlimModLoader;
function installInSlimModLoader(files, destinationPath, gameId) {
    const identifier = files.find(file => path_1.default.basename(file) === common_1.INSLIMVML_IDENTIFIER);
    const minSegIdx = identifier.split(path_1.default.sep).indexOf(common_1.INSLIMVML_IDENTIFIER);
    const instructions = files.reduce((accum, file) => {
        const segments = file.split(path_1.default.sep).filter(seg => !!seg);
        if (!path_1.default.extname(segments[segments.length - 1])) {
            return accum;
        }
        const destination = (segments.length >= minSegIdx + 1)
            ? segments.slice(minSegIdx).join(path_1.default.sep)
            : undefined;
        if (destination !== undefined) {
            accum.push({
                type: 'copy',
                source: file,
                destination,
            });
        }
        return accum;
    }, []);
    return bluebird_1.default.resolve({ instructions });
}
exports.installInSlimModLoader = installInSlimModLoader;
function testCoreRemover(files, gameId) {
    if (gameId !== common_1.GAME_ID) {
        return bluebird_1.default.resolve({ supported: false, requiredFiles: [] });
    }
    let supported = false;
    for (const file of files) {
        const segments = file.split(path_1.default.sep).map(seg => seg.toLowerCase());
        if ((segments.find(seg => isInvalidSegment(seg, INVALID_DIRS)) !== undefined)
            && (isInvalidSegment(segments[segments.length - 1], INVALID_FILES))) {
            supported = true;
            break;
        }
    }
    return bluebird_1.default.resolve({ supported, requiredFiles: [] });
}
exports.testCoreRemover = testCoreRemover;
function installCoreRemover(files, destinationPath, gameId) {
    let minSegIdx = 0;
    for (const file of files) {
        const segments = file.split(path_1.default.sep)
            .filter(seg => !!seg)
            .map(seg => seg.toLowerCase());
        if (segments.includes('plugins')) {
            minSegIdx = segments.indexOf('plugins');
            break;
        }
        if (segments.includes('patchers')) {
            minSegIdx = segments.indexOf('patchers');
            break;
        }
    }
    const instructions = files.reduce((accum, iter) => {
        const segments = iter.split(path_1.default.sep).filter(seg => !!seg);
        if (!segments.find(seg => isInvalidSegment(seg.toLowerCase(), INVALID_DIRS))
            && (!isInvalidSegment(segments[segments.length - 1].toLowerCase(), INVALID_FILES))
            && !!path_1.default.extname(segments[segments.length - 1])) {
            const destination = (segments.length > minSegIdx + 1)
                ? segments.slice(minSegIdx).join(path_1.default.sep)
                : undefined;
            if (destination !== undefined) {
                const instr = {
                    type: 'copy',
                    source: iter,
                    destination,
                };
                accum.push(instr);
            }
        }
        return accum;
    }, []);
    return bluebird_1.default.resolve({ instructions });
}
exports.installCoreRemover = installCoreRemover;
function testFullPack(files, gameId) {
    if (gameId !== common_1.GAME_ID) {
        return bluebird_1.default.resolve({ supported: false, requiredFiles: [] });
    }
    let supported = false;
    for (const file of files) {
        const segments = file.split(path_1.default.sep).map(seg => seg.toLowerCase());
        const coreLibIdx = indexOfPackSegment(segments);
        if (coreLibIdx === -1) {
            continue;
        }
        if (coreLibIdx !== undefined) {
            supported = true;
            break;
        }
    }
    return bluebird_1.default.resolve({ supported, requiredFiles: [] });
}
exports.testFullPack = testFullPack;
function testConfManager(files, gameId) {
    if (gameId !== common_1.GAME_ID) {
        return bluebird_1.default.resolve({ supported: false, requiredFiles: [] });
    }
    const supported = files.find(file => path_1.default.basename(file).toLowerCase() === common_1.CONF_MANAGER) !== undefined;
    return bluebird_1.default.resolve({ supported, requiredFiles: [] });
}
exports.testConfManager = testConfManager;
function installConfManager(files, destinationPath, gameId) {
    const confManager = files.find(file => path_1.default.basename(file).toLowerCase() === common_1.CONF_MANAGER);
    const modTypeInstr = {
        type: 'setmodtype',
        value: 'val-conf-man',
    };
    const copyInstr = {
        type: 'copy',
        source: confManager,
        destination: path_1.default.join('plugins', 'ConfigurationManager', path_1.default.basename(confManager)),
    };
    return bluebird_1.default.resolve({ instructions: [modTypeInstr, copyInstr] });
}
exports.installConfManager = installConfManager;
function installFullPack(files, destinationPath, gameId) {
    let coreLibIdx = -1;
    let packType;
    const filtered = files.filter(file => {
        const segments = file.split(path_1.default.sep).map(seg => seg.toLowerCase());
        if (!path_1.default.extname(segments[segments.length - 1])) {
            return false;
        }
        if (coreLibIdx === -1) {
            coreLibIdx = indexOfPackSegment(segments);
            packType = getPackType(segments[coreLibIdx]);
            if (coreLibIdx !== -1) {
                return true;
            }
        }
        else {
            if (PACK_SEGMENTS.includes(segments[coreLibIdx])) {
                return true;
            }
        }
        return false;
    });
    if (packType === 'none') {
        return bluebird_1.default.reject(new vortex_api_1.util.NotSupportedError());
    }
    const modTypeInstr = (packType === 'core_lib')
        ? {
            type: 'setmodtype',
            value: 'bepinex-root-mod',
        } : {
        type: 'setmodtype',
        value: 'unstripped-assemblies',
    };
    const modAttribInstr = {
        type: 'attribute',
        key: 'CoreLibType',
        value: packType,
    };
    const instructions = [modTypeInstr, modAttribInstr]
        .concat(filtered.map(file => ({
        type: 'copy',
        source: file,
        destination: file.split(path_1.default.sep).slice(coreLibIdx).join(path_1.default.sep),
    })));
    return bluebird_1.default.resolve({ instructions });
}
exports.installFullPack = installFullPack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5zdGFsbGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImluc3RhbGxlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsd0RBQStCO0FBQy9CLGdEQUF3QjtBQUV4QiwyQ0FBeUM7QUFDekMscUNBQytEO0FBRS9ELE1BQU0sWUFBWSxHQUFHLENBQUMsTUFBTSxFQUFFLGNBQWMsQ0FBQyxDQUFDO0FBQzlDLE1BQU0sYUFBYSxHQUFHLENBQUMseUJBQWdCLENBQUMsQ0FBQyxNQUFNLENBQUMsd0JBQWUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO0FBQ2pHLE1BQU0sYUFBYSxHQUFHLENBQUMsVUFBVSxFQUFFLG1CQUFtQixDQUFDLENBQUM7QUFFeEQsU0FBUyxrQkFBa0IsQ0FBQyxRQUFrQjtJQUM1QyxNQUFNLGNBQWMsR0FBRyxDQUFDLEdBQVcsRUFBRSxFQUFFLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNwRSxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQzlDLElBQUksT0FBTyxLQUFLLFNBQVMsRUFBRTtRQUN6QixPQUFPLFFBQVEsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDbEM7SUFDRCxPQUFPLENBQUMsQ0FBQyxDQUFDO0FBQ1osQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLEdBQVc7SUFDOUIsUUFBUSxHQUFHLEVBQUU7UUFDWCxLQUFLLFVBQVU7WUFDYixPQUFPLFVBQVUsQ0FBQztRQUNwQixLQUFLLG1CQUFtQjtZQUN0QixPQUFPLG1CQUFtQixDQUFDO1FBQzdCO1lBQ0UsT0FBTyxNQUFNLENBQUM7S0FDakI7QUFDSCxDQUFDO0FBRUQsU0FBUyxnQkFBZ0IsQ0FBQyxlQUF1QixFQUFFLGlCQUEyQjtJQUM1RSxPQUFPLGlCQUFpQixD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RyxFQUFFLGFBQWE7UUFDbEIsS0FBSyxFQUFFLFFBQVE7S0FDaEIsQ0FBQztJQUNGLE1BQU0sWUFBWSxHQUF5QixDQUFDLFlBQVksRUFBRSxjQUFjLENBQUM7U0FDdEUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzVCLElBQUksRUFBRSxNQUFNO1FBQ1osTUFBTSxFQUFFLElBQUk7UUFDWixXQUFXLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFJLENBQUMsR0FBRyxDQUFDO0tBQ3JFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFTCxPQUFPLGtCQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQztBQUMzQyxDQUFDO0FBaERELDBDQWdEQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQcm9taXNlIGZyb20gJ2JsdWViaXJkJztcclxuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XHJcblxyXG5pbXBvcnQgeyB0eXBlcywgdXRpbCB9IGZyb20gJ3ZvcnRleC1hcGknO1xyXG5pbXBvcnQgeyBCRVRURVJfQ09OVF9FWFQsIENPTkZfTUFOQUdFUiwgRE9PUlNUT1BQRVJfSE9PSywgR0FNRV9JRCwgSUdOT1JBQkxFX0ZJTEVTLFxyXG4gIElOU0xJTVZNTF9JREVOVElGSUVSLCBQYWNrVHlwZSwgVkJVSUxEX0VYVCB9IGZyb20gJy4vY29tbW9uJztcclxuXHJcbmNvbnN0IElOVkFMSURfRElSUyA9IFsnY29yZScsICd2YWxoZWltX2RhdGEnXTtcclxuY29uc3QgSU5WQUxJRF9GSUxFUyA9IFtET09SU1RPUFBFUl9IT09LXS5jb25jYXQoSUdOT1JBQkxFX0ZJTEVTKS5tYXAoZmlsZSA9PiBmaWxlLnRvTG93ZXJDYXNlKCkpO1xyXG5jb25zdCBQQUNLX1NFR01FTlRTID0gWydjb3JlX2xpYicsICd1bnN0cmlwcGVkX2NvcmxpYiddO1xyXG5cclxuZnVuY3Rpb24gaW5kZXhPZlBhY2tTZWdtZW50KHNlZ21lbnRzOiBzdHJpbmdbXSkge1xyXG4gIGNvbnN0IGhhc1BhY2tTZWdtZW50ID0gKHNlZzogc3RyaW5nKSA9PiBQQUNLX1NFR01FTlRTLmluY2x1ZGVzKHNlZyk7XHJcbiAgY29uc3Qgc2VnbWVudCA9IHNlZ21lbnRzLmZpbmQoaGFzUGFja1NlZ21lbnQpO1xyXG4gIGlmIChzZWdtZW50ICE9PSB1bmRlZmluZWQpIHtcclxuICAgIHJldHVybiBzZWdtZW50cy5pbmRleE9mKHNlZ21lbnQpO1xyXG4gIH1cclxuICByZXR1cm4gLTE7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFBhY2tUeXBlKHNlZzogc3RyaW5nKTogUGFja1R5cGUge1xyXG4gIHN3aXRjaCAoc2VnKSB7XHJcbiAgICBjYXNlICdjb3JlX2xpYic6XHJcbiAgICAgIHJldHVybiAnY29yZV9saWInO1xyXG4gICAgY2FzZSAndW5zdHJpcHBlZF9jb3JsaWInOlxyXG4gICAgICByZXR1cm4gJ3Vuc3RyaXBwZWRfY29ybGliJztcclxuICAgIGRlZmF1bHQ6XHJcbiAgICAgIHJldHVybiAnbm9uZSc7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBpc0ludmFsaWRTZWdtZW50KGZpbGVQYXRoU2VnbWVudDogc3RyaW5nLCBpbnZhbGlkQ29sbGVjdGlvbjogc3RyaW5nW10pIHtcclxuICByZXR1cm4gaW52YWxpZENvbGxlY3Rpb24uaW5jbHVkZXMoZmlsZVBhdGhTZWdtZW50KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHRlc3RCZXR0ZXJDb250KGZpbGVzOiBzdHJpbmdbXSwgZ2FtZUlkOiBzdHJpbmcpOiBQcm9taXNlPHR5cGVzLklTdXBwb3J0ZWRSZXN1bHQ+IHtcclxuICBpZiAoZ2FtZUlkICE9PSBHQU1FX0lEKSB7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3VwcG9ydGVkOiBmYWxzZSwgcmVxdWlyZWRGaWxlczogW10gfSk7XHJcbiAgfVxyXG5cclxuICBjb25zdCBzdXBwb3J0ZWQgPSBmaWxlcy5maW5kKGZpbGUgPT5cclxuICAgIHBhdGguZXh0bmFtZShmaWxlKS50b0xvd2VyQ2FzZSgpID09PSBCRVRURVJfQ09OVF9FWFQpICE9PSB1bmRlZmluZWQ7XHJcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN1cHBvcnRlZCwgcmVxdWlyZWRGaWxlczogW10gfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbnN0YWxsQmV0dGVyQ29udChmaWxlczogc3RyaW5nW10sIGRlc3RpbmF0aW9uUGF0aDogc3RyaW5nLCBnYW1lSWQ6IHN0cmluZykge1xyXG4gIGNvbnN0IGZpbHRlcmVkID0gZmlsZXMuZmlsdGVyKHBhdGguZXh0bmFtZSk7XHJcbiAgY29uc3QgYmV0dGVyQ29udEZpbGUgPSBmaWx0ZXJlZC5maW5kKGZpbGUgPT5cclxuICAgIHBhdGguZXh0bmFtZShmaWxlKS50b0xvd2VyQ2FzZSgpID09PSBCRVRURVJfQ09OVF9FWFQpO1xyXG4gIGNvbnN0IGlkeCA9IGJldHRlckNvbnRGaWxlLnNwbGl0KHBhdGguc2VwKS5pbmRleE9mKHBhdGguYmFzZW5hbWUoYmV0dGVyQ29udEZpbGUpKTtcclxuICBjb25zdCBpbnN0cnVjdGlvbnM6IHR5cGVzLklJbnN0cnVjdGlvbltdID0gZmlsdGVyZWQubWFwKGZpbGUgPT4gKHtcclxuICAgIHR5cGU6ICdjb3B5JyxcclxuICAgIHNvdXJjZTogZmlsZSxcclxuICAgIGRlc3RpbmF0aW9uOiBmaWxlLnNwbGl0KHBhdGguc2VwKS5zbGljZShpZHgpLmpvaW4ocGF0aC5zZXApLFxyXG4gIH0pKTtcclxuXHJcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGluc3RydWN0aW9ucyB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHRlc3RWQnVpbGQoZmlsZXM6IHN0cmluZ1tdLCBnYW1lSWQ6IHN0cmluZyk6IFByb21pc2U8dHlwZXMuSVN1cHBvcnRlZFJlc3VsdD4ge1xyXG4gIGlmIChnYW1lSWQgIT09IEdBTUVfSUQpIHtcclxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdXBwb3J0ZWQ6IGZhbHNlLCByZXF1aXJlZEZpbGVzOiBbXSB9KTtcclxuICB9XHJcblxyXG4gIGNvbnN0IHN1cHBvcnRlZCA9IGZpbGVzLmZpbmQoZmlsZSA9PiBwYXRoLmV4dG5hbWUoZmlsZSkgPT09IFZCVUlMRF9FWFQpICE9PSB1bmRlZmluZWQ7XHJcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN1cHBvcnRlZCwgcmVxdWlyZWRGaWxlczogW10gfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbnN0YWxsVkJ1aWxkTW9kKGZpbGVzOiBzdHJpbmdbXSwgZGVzdGluYXRpb25QYXRoOiBzdHJpbmcsIGdhbWVJZDogc3RyaW5nKSB7XHJcbiAgY29uc3QgZmlsdGVyZWQgPSBmaWxlcy5maWx0ZXIoZmlsZSA9PiBwYXRoLmV4dG5hbWUoZmlsZSkgPT09IFZCVUlMRF9FWFQpO1xyXG4gIGNvbnN0IGluc3RydWN0aW9uczogdHlwZXMuSUluc3RydWN0aW9uW10gPSBmaWx0ZXJlZC5tYXAoZmlsZSA9PiAoe1xyXG4gICAgdHlwZTogJ2NvcHknLFxyXG4gICAgc291cmNlOiBmaWxlLFxyXG4gICAgZGVzdGluYXRpb246IHBhdGguYmFzZW5hbWUoZmlsZSksXHJcbiAgfSkpO1xyXG5cclxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgaW5zdHJ1Y3Rpb25zIH0pO1xyXG59XHJcblxyXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1heC1saW5lLWxlbmd0aFxyXG5leHBvcnQgZnVuY3Rpb24gdGVzdEluU2xpbU1vZExvYWRlcihmaWxlczogc3RyaW5nW10sIGdhbWVJZDogc3RyaW5nKTogUHJvbWlzZTx0eXBlcy5JU3VwcG9ydGVkUmVzdWx0PiB7XHJcbiAgaWYgKGdhbWVJZCAhPT0gR0FNRV9JRCkge1xyXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN1cHBvcnRlZDogZmFsc2UsIHJlcXVpcmVkRmlsZXM6IFtdIH0pO1xyXG4gIH1cclxuXHJcbiAgY29uc3Qgc3VwcG9ydGVkID0gZmlsZXMuZmluZChmaWxlID0+IHBhdGguYmFzZW5hbWUoZmlsZSkgPT09IElOU0xJTVZNTF9JREVOVElGSUVSKSAhPT0gdW5kZWZpbmVkO1xyXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdXBwb3J0ZWQsIHJlcXVpcmVkRmlsZXM6IFtdIH0pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5zdGFsbEluU2xpbU1vZExvYWRlcihmaWxlczogc3RyaW5nW10sIGRlc3RpbmF0aW9uUGF0aDogc3RyaW5nLCBnYW1lSWQ6IHN0cmluZykge1xyXG4gIC8vIFRoaXMgZ2FtZSBleHRlbnNpb24gY29tZXMgd2l0aCB0aGUgSW5TbGltVk1MIHVuaXR5IGRvb3Igc3RvcHBlciBhc3NlbWJseSBieSBkZWZhdWx0LCBubyBwb2ludFxyXG4gIC8vICBpbiBhZGRpbmcgaXQuXHJcbiAgY29uc3QgaWRlbnRpZmllciA9IGZpbGVzLmZpbmQoZmlsZSA9PiBwYXRoLmJhc2VuYW1lKGZpbGUpID09PSBJTlNMSU1WTUxfSURFTlRJRklFUik7XHJcbiAgY29uc3QgbWluU2VnSWR4ID0gaWRlbnRpZmllci5zcGxpdChwYXRoLnNlcCkuaW5kZXhPZihJTlNMSU1WTUxfSURFTlRJRklFUik7XHJcbiAgY29uc3QgaW5zdHJ1Y3Rpb25zOiB0eXBlcy5JSW5zdHJ1Y3Rpb25bXSA9IGZpbGVzLnJlZHVjZSgoYWNjdW0sIGZpbGUpID0+IHtcclxuICAgIGNvbnN0IHNlZ21lbnRzID0gZmlsZS5zcGxpdChwYXRoLnNlcCkuZmlsdGVyKHNlZyA9PiAhIXNlZyk7XHJcbiAgICBpZiAoIXBhdGguZXh0bmFtZShzZWdtZW50c1tzZWdtZW50cy5sZW5ndGggLSAxXSkpIHtcclxuICAgICAgLy8gVGhpcyBpcyBhIGRpcmVjdG9yeSwgd2UgZG9uJ3QgbmVlZCBpdC5cclxuICAgICAgcmV0dXJuIGFjY3VtO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZGVzdGluYXRpb24gPSAoc2VnbWVudHMubGVuZ3RoID49IG1pblNlZ0lkeCArIDEpXHJcbiAgICAgID8gc2VnbWVudHMuc2xpY2UobWluU2VnSWR4KS5qb2luKHBhdGguc2VwKVxyXG4gICAgICA6IHVuZGVmaW5lZDtcclxuICAgIGlmIChkZXN0aW5hdGlvbiAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIGFjY3VtLnB1c2goe1xyXG4gICAgICAgIHR5cGU6ICdjb3B5JyxcclxuICAgICAgICBzb3VyY2U6IGZpbGUsXHJcbiAgICAgICAgZGVzdGluYXRpb24sXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGFjY3VtO1xyXG4gIH0sIFtdKTtcclxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgaW5zdHJ1Y3Rpb25zIH0pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdGVzdENvcmVSZW1vdmVyKGZpbGVzOiBzdHJpbmdbXSwgZ2FtZUlkOiBzdHJpbmcpOiBQcm9taXNlPHR5cGVzLklTdXBwb3J0ZWRSZXN1bHQ+IHtcclxuICBpZiAoZ2FtZUlkICE9PSBHQU1FX0lEKSB7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3VwcG9ydGVkOiBmYWxzZSwgcmVxdWlyZWRGaWxlczogW10gfSk7XHJcbiAgfVxyXG4gIGxldCBzdXBwb3J0ZWQgPSBmYWxzZTtcclxuICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHtcclxuICAgIGNvbnN0IHNlZ21lbnRzID0gZmlsZS5zcGxpdChwYXRoLnNlcCkubWFwKHNlZyA9PiBzZWcudG9Mb3dlckNhc2UoKSk7XHJcbiAgICBpZiAoKHNlZ21lbnRzLmZpbmQoc2VnID0+IGlzSW52YWxpZFNlZ21lbnQoc2VnLCBJTlZBTElEX0RJUlMpKSAhPT0gdW5kZWZpbmVkKVxyXG4gICAgICAmJiAoaXNJbnZhbGlkU2VnbWVudChzZWdtZW50c1tzZWdtZW50cy5sZW5ndGggLSAxXSwgSU5WQUxJRF9GSUxFUykpKSB7XHJcbiAgICAgICAgc3VwcG9ydGVkID0gdHJ1ZTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG4gIH1cclxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3VwcG9ydGVkLCByZXF1aXJlZEZpbGVzOiBbXSB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGluc3RhbGxDb3JlUmVtb3ZlcihmaWxlczogc3RyaW5nW10sIGRlc3RpbmF0aW9uUGF0aDogc3RyaW5nLCBnYW1lSWQ6IHN0cmluZykge1xyXG4gIC8vIE1hbnkgZXhpc3RpbmcgbW9kcyBoYXZlIEJlcEluRXgncyBjb3JlIGRpcmVjdG9yeSBwcmUtaW5jbHVkZWQsIHdlIGRvIG5vdCB3YW50XHJcbiAgLy8gIHRob3NlIGZpbGVzIGluc3RhbGxlZCBhcyBpdCB3aWxsIGp1c3QgY2F1c2UgdW5leHBlY3RlZCBiZWhhdmlvdXIuXHJcbiAgbGV0IG1pblNlZ0lkeCA9IDA7XHJcbiAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XHJcbiAgICBjb25zdCBzZWdtZW50cyA9IGZpbGUuc3BsaXQocGF0aC5zZXApXHJcbiAgICAgIC5maWx0ZXIoc2VnID0+ICEhc2VnKVxyXG4gICAgICAubWFwKHNlZyA9PiBzZWcudG9Mb3dlckNhc2UoKSk7XHJcblxyXG4gICAgaWYgKHNlZ21lbnRzLmluY2x1ZGVzKCdwbHVnaW5zJykpIHtcclxuICAgICAgbWluU2VnSWR4ID0gc2VnbWVudHMuaW5kZXhPZigncGx1Z2lucycpO1xyXG4gICAgICBicmVhaztcclxuICAgIH1cclxuICAgIGlmIChzZWdtZW50cy5pbmNsdWRlcygncGF0Y2hlcnMnKSkge1xyXG4gICAgICBtaW5TZWdJZHggPSBzZWdtZW50cy5pbmRleE9mKCdwYXRjaGVycycpO1xyXG4gICAgICBicmVhaztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNvbnN0IGluc3RydWN0aW9uczogdHlwZXMuSUluc3RydWN0aW9uW10gPSBmaWxlcy5yZWR1Y2UoKGFjY3VtLCBpdGVyKSA9PiB7XHJcbiAgICBjb25zdCBzZWdtZW50cyA9IGl0ZXIuc3BsaXQocGF0aC5zZXApLmZpbHRlcihzZWcgPT4gISFzZWcpO1xyXG5cclxuICAgIGlmICghc2VnbWVudHMuZmluZChzZWcgPT4gaXNJbnZhbGlkU2VnbWVudChzZWcudG9Mb3dlckNhc2UoKSwgSU5WQUxJRF9ESVJTKSlcclxuICAgICAgJiYgKCFpc0ludmFsaWRTZWdtZW50KHNlZ21lbnRzW3NlZ21lbnRzLmxlbmd0aCAtIDFdLnRvTG93ZXJDYXNlKCksIElOVkFMSURfRklMRVMpKVxyXG4gICAgICAmJiAhIXBhdGguZXh0bmFtZShzZWdtZW50c1tzZWdtZW50cy5sZW5ndGggLSAxXSkpIHtcclxuICAgICAgICBjb25zdCBkZXN0aW5hdGlvbiA9IChzZWdtZW50cy5sZW5ndGggPiBtaW5TZWdJZHggKyAxKVxyXG4gICAgICAgICAgPyBzZWdtZW50cy5zbGljZShtaW5TZWdJZHgpLmpvaW4ocGF0aC5zZXApXHJcbiAgICAgICAgICA6IHVuZGVmaW5lZDtcclxuXHJcbiAgICAgICAgaWYgKGRlc3RpbmF0aW9uICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgIGNvbnN0IGluc3RyOiB0eXBlcy5JSW5zdHJ1Y3Rpb24gPSB7XHJcbiAgICAgICAgICAgIHR5cGU6ICdjb3B5JyxcclxuICAgICAgICAgICAgc291cmNlOiBpdGVyLFxyXG4gICAgICAgICAgICBkZXN0aW5hdGlvbixcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICBhY2N1bS5wdXNoKGluc3RyKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYWNjdW07XHJcbiAgfSwgW10pO1xyXG5cclxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgaW5zdHJ1Y3Rpb25zIH0pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdGVzdEZ1bGxQYWNrKGZpbGVzOiBzdHJpbmdbXSwgZ2FtZUlkOiBzdHJpbmcpOiBQcm9taXNlPHR5cGVzLklTdXBwb3J0ZWRSZXN1bHQ+IHtcclxuICBpZiAoZ2FtZUlkICE9PSBHQU1FX0lEKSB7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3VwcG9ydGVkOiBmYWxzZSwgcmVxdWlyZWRGaWxlczogW10gfSk7XHJcbiAgfVxyXG4gIGxldCBzdXBwb3J0ZWQgPSBmYWxzZTtcclxuICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHtcclxuICAgIGNvbnN0IHNlZ21lbnRzID0gZmlsZS5zcGxpdChwYXRoLnNlcCkubWFwKHNlZyA9PiBzZWcudG9Mb3dlckNhc2UoKSk7XHJcbiAgICBjb25zdCBjb3JlTGliSWR4ID0gaW5kZXhPZlBhY2tTZWdtZW50KHNlZ21lbnRzKTtcclxuICAgIGlmIChjb3JlTGliSWR4ID09PSAtMSkge1xyXG4gICAgICBjb250aW51ZTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoY29yZUxpYklkeCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHN1cHBvcnRlZCA9IHRydWU7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gIH1cclxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3VwcG9ydGVkLCByZXF1aXJlZEZpbGVzOiBbXSB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHRlc3RDb25mTWFuYWdlcihmaWxlczogc3RyaW5nW10sIGdhbWVJZDogc3RyaW5nKTogUHJvbWlzZTx0eXBlcy5JU3VwcG9ydGVkUmVzdWx0PiB7XHJcbiAgaWYgKGdhbWVJZCAhPT0gR0FNRV9JRCkge1xyXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN1cHBvcnRlZDogZmFsc2UsIHJlcXVpcmVkRmlsZXM6IFtdIH0pO1xyXG4gIH1cclxuXHJcbiAgY29uc3Qgc3VwcG9ydGVkID0gZmlsZXMuZmluZChmaWxlID0+IHBhdGguYmFzZW5hbWUoZmlsZSkudG9Mb3dlckNhc2UoKSA9PT0gQ09ORl9NQU5BR0VSKSAhPT0gdW5kZWZpbmVkO1xyXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdXBwb3J0ZWQsIHJlcXVpcmVkRmlsZXM6IFtdIH0pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5zdGFsbENvbmZNYW5hZ2VyKGZpbGVzOiBzdHJpbmdbXSwgZGVzdGluYXRpb25QYXRoOiBzdHJpbmcsIGdhbWVJZDogc3RyaW5nKSB7XHJcbiAgY29uc3QgY29uZk1hbmFnZXIgPSBmaWxlcy5maW5kKGZpbGUgPT4gcGF0aC5iYXNlbmFtZShmaWxlKS50b0xvd2VyQ2FzZSgpID09PSBDT05GX01BTkFHRVIpO1xyXG4gIGNvbnN0IG1vZFR5cGVJbnN0cjogdHlwZXMuSUluc3RydWN0aW9uID0ge1xyXG4gICAgICB0eXBlOiAnc2V0bW9kdHlwZScsXHJcbiAgICAgIHZhbHVlOiAndmFsLWNvbmYtbWFuJyxcclxuICB9O1xyXG4gIGNvbnN0IGNvcHlJbnN0cjogdHlwZXMuSUluc3RydWN0aW9uID0ge1xyXG4gICAgdHlwZTogJ2NvcHknLFxyXG4gICAgc291cmNlOiBjb25mTWFuYWdlcixcclxuICAgIGRlc3RpbmF0aW9uOiBwYXRoLmpvaW4oJ3BsdWdpbnMnLCAnQ29uZmlndXJhdGlvbk1hbmFnZXInLCBwYXRoLmJhc2VuYW1lKGNvbmZNYW5hZ2VyKSksXHJcbiAgfTtcclxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgaW5zdHJ1Y3Rpb25zOiBbbW9kVHlwZUluc3RyLCBjb3B5SW5zdHJdIH0pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5zdGFsbEZ1bGxQYWNrKGZpbGVzOiBzdHJpbmdbXSwgZGVzdGluYXRpb25QYXRoOiBzdHJpbmcsIGdhbWVJZDogc3RyaW5nKSB7XHJcbiAgbGV0IGNvcmVMaWJJZHggPSAtMTtcclxuICBsZXQgcGFja1R5cGU6IFBhY2tUeXBlO1xyXG4gIGNvbnN0IGZpbHRlcmVkID0gZmlsZXMuZmlsdGVyKGZpbGUgPT4ge1xyXG4gICAgY29uc3Qgc2VnbWVudHMgPSBmaWxlLnNwbGl0KHBhdGguc2VwKS5tYXAoc2VnID0+IHNlZy50b0xvd2VyQ2FzZSgpKTtcclxuICAgIGlmICghcGF0aC5leHRuYW1lKHNlZ21lbnRzW3NlZ21lbnRzLmxlbmd0aCAtIDFdKSkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBpZiAoY29yZUxpYklkeCA9PT0gLTEpIHtcclxuICAgICAgY29yZUxpYklkeCA9IGluZGV4T2ZQYWNrU2VnbWVudChzZWdtZW50cyk7XHJcbiAgICAgIHBhY2tUeXBlID0gZ2V0UGFja1R5cGUoc2VnbWVudHNbY29yZUxpYklkeF0pO1xyXG4gICAgICBpZiAoY29yZUxpYklkeCAhPT0gLTEpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaWYgKFBBQ0tfU0VHTUVOVFMuaW5jbHVkZXMoc2VnbWVudHNbY29yZUxpYklkeF0pKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9KTtcclxuXHJcbiAgaWYgKHBhY2tUeXBlID09PSAnbm9uZScpIHtcclxuICAgIC8vIEhvdyBkaWQgd2UgZ2V0IGhlcmUgaWYgdGhpcyBpc24ndCBhbiB1bnN0cmlwcGVkIGFzc2VtYmxpZXMgcGFja2FnZT9cclxuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgdXRpbC5Ob3RTdXBwb3J0ZWRFcnJvcigpKTtcclxuICB9XHJcbiAgY29uc3QgbW9kVHlwZUluc3RyOiB0eXBlcy5JSW5zdHJ1Y3Rpb24gPSAocGFja1R5cGUgPT09ICdjb3JlX2xpYicpXHJcbiAgICA/IHtcclxuICAgICAgdHlwZTogJ3NldG1vZHR5cGUnLFxyXG4gICAgICB2YWx1ZTogJ2JlcGluZXgtcm9vdC1tb2QnLFxyXG4gICAgfSA6IHtcclxuICAgICAgdHlwZTogJ3NldG1vZHR5cGUnLFxyXG4gICAgICB2YWx1ZTogJ3Vuc3RyaXBwZWQtYXNzZW1ibGllcycsXHJcbiAgICB9O1xyXG5cclxuICBjb25zdCBtb2RBdHRyaWJJbnN0cjogdHlwZXMuSUluc3RydWN0aW9uID0ge1xyXG4gICAgdHlwZTogJ2F0dHJpYnV0ZScsXHJcbiAgICBrZXk6ICdDb3JlTGliVHlwZScsXHJcbiAgICB2YWx1ZTogcGFja1R5cGUsXHJcbiAgfTtcclxuICBjb25zdCBpbnN0cnVjdGlvbnM6IHR5cGVzLklJbnN0cnVjdGlvbltdID0gW21vZFR5cGVJbnN0ciwgbW9kQXR0cmliSW5zdHJdXHJcbiAgICAuY29uY2F0KGZpbHRlcmVkLm1hcChmaWxlID0+ICh7XHJcbiAgICAgIHR5cGU6ICdjb3B5JyxcclxuICAgICAgc291cmNlOiBmaWxlLFxyXG4gICAgICBkZXN0aW5hdGlvbjogZmlsZS5zcGxpdChwYXRoLnNlcCkuc2xpY2UoY29yZUxpYklkeCkuam9pbihwYXRoLnNlcCksXHJcbiAgfSkpKTtcclxuXHJcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGluc3RydWN0aW9ucyB9KTtcclxufVxyXG4iXX0=